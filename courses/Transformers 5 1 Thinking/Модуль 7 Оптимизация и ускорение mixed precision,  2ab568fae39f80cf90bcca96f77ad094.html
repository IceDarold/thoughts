<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><title>–ú–æ–¥—É–ª—å 7. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∏ —É—Å–∫–æ—Ä–µ–Ω–∏–µ: mixed precision, accelerate, –±–æ–ª—å—à–∏–µ –º–æ–¥–µ–ª–∏ –∏ –∫–≤–∞–Ω—Ç–æ–≤–∞–Ω–∏–µ</title><style>
/* cspell:disable-file */
/* webkit printing magic: print all background colors */
html {
	-webkit-print-color-adjust: exact;
}
* {
	box-sizing: border-box;
	-webkit-print-color-adjust: exact;
}

html,
body {
	margin: 0;
	padding: 0;
}
@media only screen {
	body {
		margin: 2em auto;
		max-width: 900px;
		color: rgb(55, 53, 47);
	}
}

body {
	line-height: 1.5;
	white-space: pre-wrap;
}

a,
a.visited {
	color: inherit;
	text-decoration: underline;
}

.pdf-relative-link-path {
	font-size: 80%;
	color: #444;
}

h1,
h2,
h3 {
	letter-spacing: -0.01em;
	line-height: 1.2;
	font-weight: 600;
	margin-bottom: 0;
}

.page-title {
	font-size: 2.5rem;
	font-weight: 700;
	margin-top: 0;
	margin-bottom: 0.75em;
}

h1 {
	font-size: 1.875rem;
	margin-top: 1.875rem;
}

h2 {
	font-size: 1.5rem;
	margin-top: 1.5rem;
}

h3 {
	font-size: 1.25rem;
	margin-top: 1.25rem;
}

.source {
	border: 1px solid #ddd;
	border-radius: 3px;
	padding: 1.5em;
	word-break: break-all;
}

.callout {
	border-radius: 10px;
	padding: 1rem;
}

figure {
	margin: 1.25em 0;
	page-break-inside: avoid;
}

figcaption {
	opacity: 0.5;
	font-size: 85%;
	margin-top: 0.5em;
}

mark {
	background-color: transparent;
}

.indented {
	padding-left: 1.5em;
}

hr {
	background: transparent;
	display: block;
	width: 100%;
	height: 1px;
	visibility: visible;
	border: none;
	border-bottom: 1px solid rgba(55, 53, 47, 0.09);
}

img {
	max-width: 100%;
}

@media only print {
	img {
		max-height: 100vh;
		object-fit: contain;
	}
}

@page {
	margin: 1in;
}

.collection-content {
	font-size: 0.875rem;
}

.collection-content td {
	white-space: pre-wrap;
	word-break: break-word;
}

.column-list {
	display: flex;
	justify-content: space-between;
}

.column {
	padding: 0 1em;
}

.column:first-child {
	padding-left: 0;
}

.column:last-child {
	padding-right: 0;
}

.table_of_contents-item {
	display: block;
	font-size: 0.875rem;
	line-height: 1.3;
	padding: 0.125rem;
}

.table_of_contents-indent-1 {
	margin-left: 1.5rem;
}

.table_of_contents-indent-2 {
	margin-left: 3rem;
}

.table_of_contents-indent-3 {
	margin-left: 4.5rem;
}

.table_of_contents-link {
	text-decoration: none;
	opacity: 0.7;
	border-bottom: 1px solid rgba(55, 53, 47, 0.18);
}

table,
th,
td {
	border: 1px solid rgba(55, 53, 47, 0.09);
	border-collapse: collapse;
}

table {
	border-left: none;
	border-right: none;
}

th,
td {
	font-weight: normal;
	padding: 0.25em 0.5em;
	line-height: 1.5;
	min-height: 1.5em;
	text-align: left;
}

th {
	color: rgba(55, 53, 47, 0.6);
}

ol,
ul {
	margin: 0;
	margin-block-start: 0.6em;
	margin-block-end: 0.6em;
}

li > ol:first-child,
li > ul:first-child {
	margin-block-start: 0.6em;
}

ul > li {
	list-style: disc;
}

ul.to-do-list {
	padding-inline-start: 0;
}

ul.to-do-list > li {
	list-style: none;
}

.to-do-children-checked {
	text-decoration: line-through;
	opacity: 0.375;
}

ul.toggle > li {
	list-style: none;
}

ul {
	padding-inline-start: 1.7em;
}

ul > li {
	padding-left: 0.1em;
}

ol {
	padding-inline-start: 1.6em;
}

ol > li {
	padding-left: 0.2em;
}

.mono ol {
	padding-inline-start: 2em;
}

.mono ol > li {
	text-indent: -0.4em;
}

.toggle {
	padding-inline-start: 0em;
	list-style-type: none;
}

/* Indent toggle children */
.toggle > li > details {
	padding-left: 1.7em;
}

.toggle > li > details > summary {
	margin-left: -1.1em;
}

.selected-value {
	display: inline-block;
	padding: 0 0.5em;
	background: rgba(206, 205, 202, 0.5);
	border-radius: 3px;
	margin-right: 0.5em;
	margin-top: 0.3em;
	margin-bottom: 0.3em;
	white-space: nowrap;
}

.collection-title {
	display: inline-block;
	margin-right: 1em;
}

.page-description {
	margin-bottom: 2em;
}

.simple-table {
	margin-top: 1em;
	font-size: 0.875rem;
	empty-cells: show;
}
.simple-table td {
	height: 29px;
	min-width: 120px;
}

.simple-table th {
	height: 29px;
	min-width: 120px;
}

.simple-table-header-color {
	background: rgb(247, 246, 243);
	color: black;
}
.simple-table-header {
	font-weight: 500;
}

time {
	opacity: 0.5;
}

.icon {
	display: inline-flex;
	align-items: center;
	justify-content: center;
	max-width: 1.2em;
	max-height: 1.2em;
	text-decoration: none;
	vertical-align: text-bottom;
	margin-right: 0.5em;
}

img.icon {
	border-radius: 3px;
}

.callout img.notion-static-icon {
	width: 1em;
	height: 1em;
}

.callout p {
	margin: 0;
}

.callout h1,
.callout h2,
.callout h3 {
	margin: 0 0 0.6rem;
}

.user-icon {
	width: 1.5em;
	height: 1.5em;
	border-radius: 100%;
	margin-right: 0.5rem;
}

.user-icon-inner {
	font-size: 0.8em;
}

.text-icon {
	border: 1px solid #000;
	text-align: center;
}

.page-cover-image {
	display: block;
	object-fit: cover;
	width: 100%;
	max-height: 30vh;
}

.page-header-icon {
	font-size: 3rem;
	margin-bottom: 1rem;
}

.page-header-icon-with-cover {
	margin-top: -0.72em;
	margin-left: 0.07em;
}

.page-header-icon img {
	border-radius: 3px;
}

.link-to-page {
	margin: 1em 0;
	padding: 0;
	border: none;
	font-weight: 500;
}

p > .user {
	opacity: 0.5;
}

td > .user,
td > time {
	white-space: nowrap;
}

input[type="checkbox"] {
	transform: scale(1.5);
	margin-right: 0.6em;
	vertical-align: middle;
}

p {
	margin-top: 0.5em;
	margin-bottom: 0.5em;
}

.image {
	border: none;
	margin: 1.5em 0;
	padding: 0;
	border-radius: 0;
	text-align: center;
}

.code,
code {
	background: rgba(135, 131, 120, 0.15);
	border-radius: 3px;
	padding: 0.2em 0.4em;
	border-radius: 3px;
	font-size: 85%;
	tab-size: 2;
}

code {
	color: #eb5757;
}

.code {
	padding: 1.5em 1em;
}

.code-wrap {
	white-space: pre-wrap;
	word-break: break-all;
}

.code > code {
	background: none;
	padding: 0;
	font-size: 100%;
	color: inherit;
}

blockquote {
	font-size: 1em;
	margin: 1em 0;
	padding-left: 1em;
	border-left: 3px solid rgb(55, 53, 47);
}

blockquote.quote-large {
	font-size: 1.25em;
}

.bookmark {
	text-decoration: none;
	max-height: 8em;
	padding: 0;
	display: flex;
	width: 100%;
	align-items: stretch;
}

.bookmark-title {
	font-size: 0.85em;
	overflow: hidden;
	text-overflow: ellipsis;
	height: 1.75em;
	white-space: nowrap;
}

.bookmark-text {
	display: flex;
	flex-direction: column;
}

.bookmark-info {
	flex: 4 1 180px;
	padding: 12px 14px 14px;
	display: flex;
	flex-direction: column;
	justify-content: space-between;
}

.bookmark-image {
	width: 33%;
	flex: 1 1 180px;
	display: block;
	position: relative;
	object-fit: cover;
	border-radius: 1px;
}

.bookmark-description {
	color: rgba(55, 53, 47, 0.6);
	font-size: 0.75em;
	overflow: hidden;
	max-height: 4.5em;
	word-break: break-word;
}

.bookmark-href {
	font-size: 0.75em;
	margin-top: 0.25em;
}

.sans { font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI Variable Display", "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol"; }
.code { font-family: "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace; }
.serif { font-family: Lyon-Text, Georgia, ui-serif, serif; }
.mono { font-family: iawriter-mono, Nitti, Menlo, Courier, monospace; }
.pdf .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI Variable Display", "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK JP'; }
.pdf:lang(zh-CN) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI Variable Display", "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK SC'; }
.pdf:lang(zh-TW) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI Variable Display", "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK TC'; }
.pdf:lang(ko-KR) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI Variable Display", "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK KR'; }
.pdf .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK JP'; }
.pdf:lang(zh-CN) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK SC'; }
.pdf:lang(zh-TW) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK TC'; }
.pdf:lang(ko-KR) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK KR'; }
.pdf .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK JP'; }
.pdf:lang(zh-CN) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK SC'; }
.pdf:lang(zh-TW) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK TC'; }
.pdf:lang(ko-KR) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK KR'; }
.pdf .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK JP'; }
.pdf:lang(zh-CN) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK SC'; }
.pdf:lang(zh-TW) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK TC'; }
.pdf:lang(ko-KR) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK KR'; }
.highlight-default {
	color: rgba(44, 44, 43, 1);
}
.highlight-gray {
	color: rgba(125, 122, 117, 1);
	fill: rgba(125, 122, 117, 1);
}
.highlight-brown {
	color: rgba(159, 118, 90, 1);
	fill: rgba(159, 118, 90, 1);
}
.highlight-orange {
	color: rgba(210, 123, 45, 1);
	fill: rgba(210, 123, 45, 1);
}
.highlight-yellow {
	color: rgba(203, 148, 52, 1);
	fill: rgba(203, 148, 52, 1);
}
.highlight-teal {
	color: rgba(80, 148, 110, 1);
	fill: rgba(80, 148, 110, 1);
}
.highlight-blue {
	color: rgba(56, 125, 201, 1);
	fill: rgba(56, 125, 201, 1);
}
.highlight-purple {
	color: rgba(154, 107, 180, 1);
	fill: rgba(154, 107, 180, 1);
}
.highlight-pink {
	color: rgba(193, 76, 138, 1);
	fill: rgba(193, 76, 138, 1);
}
.highlight-red {
	color: rgba(207, 81, 72, 1);
	fill: rgba(207, 81, 72, 1);
}
.highlight-default_background {
	color: rgba(44, 44, 43, 1);
}
.highlight-gray_background {
	background: rgba(42, 28, 0, 0.07);
}
.highlight-brown_background {
	background: rgba(139, 46, 0, 0.086);
}
.highlight-orange_background {
	background: rgba(224, 101, 1, 0.129);
}
.highlight-yellow_background {
	background: rgba(211, 168, 0, 0.137);
}
.highlight-teal_background {
	background: rgba(0, 100, 45, 0.09);
}
.highlight-blue_background {
	background: rgba(0, 124, 215, 0.094);
}
.highlight-purple_background {
	background: rgba(102, 0, 178, 0.078);
}
.highlight-pink_background {
	background: rgba(197, 0, 93, 0.086);
}
.highlight-red_background {
	background: rgba(223, 22, 0, 0.094);
}
.block-color-default {
	color: inherit;
	fill: inherit;
}
.block-color-gray {
	color: rgba(125, 122, 117, 1);
	fill: rgba(125, 122, 117, 1);
}
.block-color-brown {
	color: rgba(159, 118, 90, 1);
	fill: rgba(159, 118, 90, 1);
}
.block-color-orange {
	color: rgba(210, 123, 45, 1);
	fill: rgba(210, 123, 45, 1);
}
.block-color-yellow {
	color: rgba(203, 148, 52, 1);
	fill: rgba(203, 148, 52, 1);
}
.block-color-teal {
	color: rgba(80, 148, 110, 1);
	fill: rgba(80, 148, 110, 1);
}
.block-color-blue {
	color: rgba(56, 125, 201, 1);
	fill: rgba(56, 125, 201, 1);
}
.block-color-purple {
	color: rgba(154, 107, 180, 1);
	fill: rgba(154, 107, 180, 1);
}
.block-color-pink {
	color: rgba(193, 76, 138, 1);
	fill: rgba(193, 76, 138, 1);
}
.block-color-red {
	color: rgba(207, 81, 72, 1);
	fill: rgba(207, 81, 72, 1);
}
.block-color-default_background {
	color: inherit;
	fill: inherit;
}
.block-color-gray_background {
	background: rgba(240, 239, 237, 1);
}
.block-color-brown_background {
	background: rgba(245, 237, 233, 1);
}
.block-color-orange_background {
	background: rgba(251, 235, 222, 1);
}
.block-color-yellow_background {
	background: rgba(249, 243, 220, 1);
}
.block-color-teal_background {
	background: rgba(232, 241, 236, 1);
}
.block-color-blue_background {
	background: rgba(229, 242, 252, 1);
}
.block-color-purple_background {
	background: rgba(243, 235, 249, 1);
}
.block-color-pink_background {
	background: rgba(250, 233, 241, 1);
}
.block-color-red_background {
	background: rgba(252, 233, 231, 1);
}
.select-value-color-default { background-color: rgba(42, 28, 0, 0.07); }
.select-value-color-gray { background-color: rgba(28, 19, 1, 0.11); }
.select-value-color-brown { background-color: rgba(127, 51, 0, 0.156); }
.select-value-color-orange { background-color: rgba(196, 88, 0, 0.203); }
.select-value-color-yellow { background-color: rgba(209, 156, 0, 0.282); }
.select-value-color-green { background-color: rgba(0, 96, 38, 0.156); }
.select-value-color-blue { background-color: rgba(0, 118, 217, 0.203); }
.select-value-color-purple { background-color: rgba(92, 0, 163, 0.141); }
.select-value-color-pink { background-color: rgba(183, 0, 78, 0.152); }
.select-value-color-red { background-color: rgba(206, 24, 0, 0.164); }

.checkbox {
	display: inline-flex;
	vertical-align: text-bottom;
	width: 16;
	height: 16;
	background-size: 16px;
	margin-left: 2px;
	margin-right: 5px;
}

.checkbox-on {
	background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2216%22%20height%3D%2216%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%3Crect%20width%3D%2216%22%20height%3D%2216%22%20fill%3D%22%2358A9D7%22%2F%3E%0A%3Cpath%20d%3D%22M6.71429%2012.2852L14%204.9995L12.7143%203.71436L6.71429%209.71378L3.28571%206.2831L2%207.57092L6.71429%2012.2852Z%22%20fill%3D%22white%22%2F%3E%0A%3C%2Fsvg%3E");
}

.checkbox-off {
	background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2216%22%20height%3D%2216%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%3Crect%20x%3D%220.75%22%20y%3D%220.75%22%20width%3D%2214.5%22%20height%3D%2214.5%22%20fill%3D%22white%22%20stroke%3D%22%2336352F%22%20stroke-width%3D%221.5%22%2F%3E%0A%3C%2Fsvg%3E");
}
	
</style></head><body><article id="2ab568fa-e39f-80cf-90bc-ca96f77ad094" class="page sans"><header><h1 class="page-title">–ú–æ–¥—É–ª—å 7. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∏ —É—Å–∫–æ—Ä–µ–Ω–∏–µ: mixed precision, accelerate, –±–æ–ª—å—à–∏–µ –º–æ–¥–µ–ª–∏ –∏ –∫–≤–∞–Ω—Ç–æ–≤–∞–Ω–∏–µ</h1><p class="page-description"></p></header><div class="page-body"><p id="2ab568fa-e39f-809f-b580-fe2b1664e032" class="">–ü–æ–µ—Ö–∞–ª–∏ —Ä–∞–∑–≥–æ–Ω—è—Ç—å –≤—Å—ë —ç—Ç–æ –¥–æ–±—Ä–æ –ø–æ —Å–∫–æ—Ä–æ—Å—Ç–∏ üöÄ</p><p id="2ab568fa-e39f-80d6-b987-e95021e93c0b" class="">–í <strong>–º–æ–¥—É–ª–µ 7</strong> –º—ã –Ω–µ —É—á–∏–º –Ω–æ–≤—ã–µ —Ç–∏–ø—ã –º–æ–¥–µ–ª–µ–π, –∞ —É—á–∏–º <strong>–¥–µ–ª–∞—Ç—å —É–∂–µ –∑–Ω–∞–∫–æ–º—ã–µ –º–æ–¥–µ–ª–∏ –∞–¥–µ–∫–≤–∞—Ç–Ω—ã–º–∏ –ø–æ —Å–∫–æ—Ä–æ—Å—Ç–∏ –∏ –ø–∞–º—è—Ç–∏</strong>:</p><ul id="2ab568fa-e39f-80fb-a8ce-ed4aeb20c5f6" class="bulleted-list"><li style="list-style-type:disc">—á—Ç–æ–±—ã –Ω–µ –ø–∞–¥–∞—Ç—å —Å OOM –ø—Ä–∏ –æ–±—É—á–µ–Ω–∏–∏,</li></ul><ul id="2ab568fa-e39f-80ea-b793-c5ff4c10cfed" class="bulleted-list"><li style="list-style-type:disc">—á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –≥–æ–Ω—è—Ç—å –±–æ—Ç–æ–≤ –∏ —Å—É–º–º–∞—Ä–∏–∑–∞—Ç–æ—Ä—ã –Ω–∞ –æ–¥–Ω–æ–π –≤–∏–¥–µ–æ–∫–∞—Ä—Ç–µ/CPU,</li></ul><ul id="2ab568fa-e39f-8078-af3a-c18bc850ba5a" class="bulleted-list"><li style="list-style-type:disc">—á—Ç–æ–±—ã –ø–æ–Ω–∏–º–∞—Ç—å, —á—Ç–æ —Ç–∞–∫–æ–µ <code>fp16/bf16</code>, <code>gradient_accumulation</code>, <code>device_map</code>, <code>8bit/4bit</code>.</li></ul><p id="2ab568fa-e39f-80d9-a1e6-e094677c3ca4" class="">–ë—É–¥–µ–º –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å –Ω–∞ <strong>—Ç–µ—Ö –∂–µ –∑–∞–¥–∞—á–∞—Ö</strong>, —á—Ç–æ —É–∂–µ –¥–µ–ª–∞–ª–∏:</p><ul id="2ab568fa-e39f-80da-9dba-f1b5f37b943b" class="bulleted-list"><li style="list-style-type:disc">–∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Ç–∏–∫–µ—Ç–æ–≤ (–ú2‚Äì4),</li></ul><ul id="2ab568fa-e39f-80bc-ba7f-da1e2f928f7a" class="bulleted-list"><li style="list-style-type:disc">seq2seq-—Å—É–º–º–∞—Ä–∏–∑–∞—Ç–æ—Ä –¥–∏–∞–ª–æ–≥–æ–≤ (–ú5),</li></ul><ul id="2ab568fa-e39f-8033-afa6-d555907f1c73" class="bulleted-list"><li style="list-style-type:disc">–∫–∞—É–∑–∞–ª—å–Ω—ã–π —Å–∞–ø–ø–æ—Ä—Ç-–±–æ—Ç (–ú6).</li></ul><hr id="2ab568fa-e39f-808c-b5fa-ca8e571e8ca2"/><p id="2ab568fa-e39f-802e-9be0-f789d92c7b7a" class="">–°–¥–µ–ª–∞–µ–º 4 —É—Ä–æ–∫–∞:</p><ol type="1" id="2ab568fa-e39f-80fa-abf2-c27d4ae04f28" class="numbered-list" start="1"><li><strong>7.1</strong> ‚Äî Mixed precision, –≥—Ä–∞–¥–∏–µ–Ω—Ç–Ω—ã–π –∞–∫–∫—É–º—É–ª–∏–Ω–≥ –∏ —ç–∫–æ–Ω–æ–º–∏—è –ø–∞–º—è—Ç–∏ –≤ <code>Trainer</code>.<figure id="2ab568fa-e39f-804c-b3f7-de9421f3225e" class="link-to-page"><a href="%D0%9C%D0%BE%D0%B4%D1%83%D0%BB%D1%8C%207%20%D0%9E%D0%BF%D1%82%D0%B8%D0%BC%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D1%8F%20%D0%B8%20%D1%83%D1%81%D0%BA%D0%BE%D1%80%D0%B5%D0%BD%D0%B8%D0%B5%20mixed%20precision,%20/%D0%A3%D1%80%D0%BE%D0%BA%207%201%20Mixed%20precision%20%D0%B8%20gradient%20accumulation%20%D0%B2%202ab568fae39f804cb3f7de9421f3225e.html">–£—Ä–æ–∫ 7.1 Mixed precision –∏ gradient accumulation –≤ Trainer: —É—á–∏–º—Å—è –≤–ª–µ–∑–∞—Ç—å –≤ GPU –∏ –Ω–µ —Å—Ç—Ä–∞–¥–∞—Ç—å</a></figure></li></ol><ol type="1" id="2ab568fa-e39f-80a4-b4bc-d7c68c9abf57" class="numbered-list" start="2"><li><strong>7.2</strong> ‚Äî <code>accelerate</code> + —Å–≤–æ–π train loop –ø–æ–¥ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä.<figure id="2ab568fa-e39f-8037-9f48-e362d71640ce" class="link-to-page"><a href="%D0%9C%D0%BE%D0%B4%D1%83%D0%BB%D1%8C%207%20%D0%9E%D0%BF%D1%82%D0%B8%D0%BC%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D1%8F%20%D0%B8%20%D1%83%D1%81%D0%BA%D0%BE%D1%80%D0%B5%D0%BD%D0%B8%D0%B5%20mixed%20precision,%20/%D0%A3%D1%80%D0%BE%D0%BA%207%202%20Accelerate%20+%20%D1%81%D0%B2%D0%BE%D0%B9%20training%20loop%20%D0%BA%D0%BE%D0%B3%D0%B4%D0%B0%20Tra%202ab568fae39f80379f48e362d71640ce.html">–£—Ä–æ–∫ 7.2 Accelerate + —Å–≤–æ–π training loop: –∫–æ–≥–¥–∞ Trainer —É–∂–µ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç</a></figure></li></ol><ol type="1" id="2ab568fa-e39f-8093-b2e0-ecc2c5742819" class="numbered-list" start="3"><li><strong>7.3</strong> ‚Äî –ë–æ–ª—å—à–∏–µ –º–æ–¥–µ–ª–∏: <code>device_map=&quot;auto&quot;</code>, offload, 8-bit/4-bit-–∫–≤–∞–Ω—Ç–æ–≤–∞–Ω–∏–µ.<figure id="2ab568fa-e39f-804c-a3ad-ffd911429dda" class="link-to-page"><a href="%D0%9C%D0%BE%D0%B4%D1%83%D0%BB%D1%8C%207%20%D0%9E%D0%BF%D1%82%D0%B8%D0%BC%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D1%8F%20%D0%B8%20%D1%83%D1%81%D0%BA%D0%BE%D1%80%D0%B5%D0%BD%D0%B8%D0%B5%20mixed%20precision,%20/%D0%A3%D1%80%D0%BE%D0%BA%207%203%20%D0%91%D0%BE%D0%BB%D1%8C%D1%88%D0%B8%D0%B5%20%D0%BC%D0%BE%D0%B4%D0%B5%D0%BB%D0%B8%20device_map,%20offload,%208-bit%202ab568fae39f804ca3adffd911429dda.html">–£—Ä–æ–∫ 7.3 –ë–æ–ª—å—à–∏–µ –º–æ–¥–µ–ª–∏: device_map, offload, 8-bit/4-bit –∫–≤–∞–Ω—Ç–æ–≤–∞–Ω–∏–µ</a></figure></li></ol><ol type="1" id="2ab568fa-e39f-8069-be02-c35d16c83fbc" class="numbered-list" start="4"><li><strong>7.4</strong> ‚Äî –ú–∏–Ω–∏-–ø—Ä–æ–µ–∫—Ç: ‚Äú–ª—ë–≥–∫–∏–π‚Äù —Å–∞–ø–ø–æ—Ä—Ç-–±–æ—Ç/—Å—É–º–º–∞—Ä–∏–∑–∞—Ç–æ—Ä –¥–ª—è –ø—Ä–æ–¥-–∏–Ω—Ñ–µ—Ä–µ–Ω—Å–∞.<figure id="2ab568fa-e39f-807a-835e-fcf29efedcfc" class="link-to-page"><a href="%D0%9C%D0%BE%D0%B4%D1%83%D0%BB%D1%8C%207%20%D0%9E%D0%BF%D1%82%D0%B8%D0%BC%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D1%8F%20%D0%B8%20%D1%83%D1%81%D0%BA%D0%BE%D1%80%D0%B5%D0%BD%D0%B8%D0%B5%20mixed%20precision,%20/%D0%A3%D1%80%D0%BE%D0%BA%207%204%20%D0%9C%D0%B8%D0%BD%D0%B8-%D0%BF%D1%80%D0%BE%D0%B5%D0%BA%D1%82%20%D0%BB%D1%91%D0%B3%D0%BA%D0%B8%D0%B9%20%D1%81%D0%B0%D0%BF%D0%BF%D0%BE%D1%80%D1%82-%D0%B1%D0%BE%D1%82%20%D1%81%D1%83%D0%BC%D0%BC%D0%B0%D1%80%D0%B8%D0%B7%D0%B0%D1%82%202ab568fae39f807a835efcf29efedcfc.html">–£—Ä–æ–∫ 7.4. –ú–∏–Ω–∏-–ø—Ä–æ–µ–∫—Ç: –ª—ë–≥–∫–∏–π —Å–∞–ø–ø–æ—Ä—Ç-–±–æ—Ç/—Å—É–º–º–∞—Ä–∏–∑–∞—Ç–æ—Ä –¥–ª—è –ø—Ä–æ–¥-–∏–Ω—Ñ–µ—Ä–µ–Ω—Å–∞</a></figure></li></ol><hr id="2ab568fa-e39f-80ff-9324-e52f29ca0e2c"/><h2 id="2ab568fa-e39f-80b0-a41d-d996cc4c418e" class="">–£—Ä–æ–∫ 7.1. Mixed precision –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π batch size –≤ Trainer</h2><p id="2ab568fa-e39f-80c0-b1f4-dab8a89ae548" class=""><strong>–¶–µ–ª—å:</strong></p><p id="2ab568fa-e39f-80a2-af4a-d11aaf4b0df4" class="">–ù–∞—É—á–∏—Ç—å:</p><ul id="2ab568fa-e39f-8093-9aff-e994f07e1e87" class="bulleted-list"><li style="list-style-type:disc">–≤–∫–ª—é—á–∞—Ç—å <code>fp16</code> / <code>bf16</code>–æ–±—É—á–µ–Ω–∏–µ,</li></ul><ul id="2ab568fa-e39f-8075-9fdc-de4571cc09f0" class="bulleted-list"><li style="list-style-type:disc">–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å <code>gradient_accumulation_steps</code>,</li></ul><ul id="2ab568fa-e39f-800b-89f0-db8230e60d7d" class="bulleted-list"><li style="list-style-type:disc">–ø–æ–Ω–∏–º–∞—Ç—å —Ä–∞–∑–Ω–∏—Ü—É –º–µ–∂–¥—É <code>per_device_train_batch_size</code> –∏ <em>—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–º</em> batch size.</li></ul><h3 id="2ab568fa-e39f-809b-9f86-f56d602b2fba" class="">7.1.1. –ö–µ–π—Å</h3><blockquote id="2ab568fa-e39f-8014-a5da-ebc44ce63873" class="">–£ –Ω–∞—Å –µ—Å—Ç—å –º–æ–¥–µ–ª—å –∏–∑ –ú4 (–∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è —Ç–∏–∫–µ—Ç–æ–≤) –∏ –Ω–µ –æ—á–µ–Ω—å –±–æ–ª—å—à–∞—è –≤–∏–¥–µ–æ–∫–∞—Ä—Ç–∞.<p id="2ab568fa-e39f-80e1-9104-cd17de7921ed" class="">–ú—ã —Ö–æ—Ç–∏–º:</p><ul id="2ab568fa-e39f-80fb-a7cf-d5029d73161d" class="bulleted-list"><li style="list-style-type:disc">–ª–∏–±–æ <strong>—É—Å–∫–æ—Ä–∏—Ç—å</strong> –æ–±—É—á–µ–Ω–∏–µ,</li></ul><ul id="2ab568fa-e39f-8029-8288-c5177ae0cf57" class="bulleted-list"><li style="list-style-type:disc">–ª–∏–±–æ <strong>–≤–ª–µ–∑—Ç—å –≤ –ø–∞–º—è—Ç—å</strong> —Å –±–æ–ª—å—à–∏–º batch size,</li></ul><ul id="2ab568fa-e39f-8024-9598-d7d74badba6a" class="bulleted-list"><li style="list-style-type:disc">–Ω–µ –ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞—è –ª–æ–≥–∏–∫—É –æ–±—É—á–µ–Ω–∏—è ‚Äî —Ç–æ–ª—å–∫–æ –Ω–∞ —É—Ä–æ–≤–Ω–µ <code>TrainingArguments</code>.</li></ul></blockquote><h3 id="2ab568fa-e39f-80c0-80b8-f3c1232b9aef" class="">7.1.2. –ò–¥–µ—è mixed precision</h3><p id="2ab568fa-e39f-8017-aacb-cd08906fc637" class="">–û–±—ä—è—Å–Ω—è–µ–º –ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏:</p><ul id="2ab568fa-e39f-80ec-9166-c7fe80dc23f4" class="bulleted-list"><li style="list-style-type:disc"><code>fp32</code> ‚Äî —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ 32-–±–∏—Ç float‚Äô—ã.</li></ul><ul id="2ab568fa-e39f-8096-bd60-e055be1b1d0f" class="bulleted-list"><li style="list-style-type:disc"><code>fp16</code> / <code>bf16</code> ‚Äî 16-–±–∏—Ç float‚Äô—ã:<ul id="2ab568fa-e39f-8068-86c5-e1fac5957a4b" class="bulleted-list"><li style="list-style-type:circle">–º–µ–Ω—å—à–µ –ø–∞–º—è—Ç–∏,</li></ul><ul id="2ab568fa-e39f-80cc-97cd-e901cbb001d2" class="bulleted-list"><li style="list-style-type:circle">–º–æ–≥—É—Ç –±—ã—Ç—å –±—ã—Å—Ç—Ä–µ–µ –Ω–∞ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö GPU,</li></ul><ul id="2ab568fa-e39f-8051-8ea6-c69564bf2446" class="bulleted-list"><li style="list-style-type:circle">–∏–Ω–æ–≥–¥–∞ —á—É—Ç—å –º–µ–Ω–µ–µ —Å—Ç–∞–±–∏–ª—å–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ (–Ω–æ –æ–±—ã—á–Ω–æ –æ–∫).</li></ul></li></ul><p id="2ab568fa-e39f-80c3-b23e-e552e10e718b" class="">–í <code>TrainingArguments</code>:</p><ul id="2ab568fa-e39f-8050-b74a-f1aee095b43c" class="bulleted-list"><li style="list-style-type:disc"><code>fp16=True</code> ‚Äî –≤–∫–ª—é—á–∞–µ–º —Å–º–µ—à–∞–Ω–Ω—É—é —Ç–æ—á–Ω–æ—Å—Ç—å (Ampere –∏ —Ç.–ø.).</li></ul><ul id="2ab568fa-e39f-80d6-b8df-d4df4ffad0cf" class="bulleted-list"><li style="list-style-type:disc"><code>bf16=True</code> ‚Äî –µ—Å–ª–∏ GPU –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç bfloat16 (A100, –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –Ω–æ–≤—ã–µ).</li></ul><p id="2ab568fa-e39f-8099-9023-e9f9b2525c50" class="">‚ö†Ô∏è –í–∞–∂–Ω–æ: <strong>–Ω–µ –≤–∫–ª—é—á–∞—Ç—å –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ</strong> <code>fp16</code> –∏ <code>bf16</code>.</p><h3 id="2ab568fa-e39f-807b-bf7e-f2ec47652dd2" class="">7.1.3. –ì—Ä–∞–¥–∏–µ–Ω—Ç–Ω—ã–π –∞–∫–∫—É–º—É–ª–∏–Ω–≥ (gradient accumulation)</h3><ul id="2ab568fa-e39f-8062-bfa6-e5a61e289d5f" class="bulleted-list"><li style="list-style-type:disc"><code>per_device_train_batch_size</code> ‚Äî —Å–∫–æ–ª—å–∫–æ —Å—ç–º–ø–ª–æ–≤ –≤ –æ–¥–Ω–æ–º –±–∞—Ç—á–µ <strong>–Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ</strong>.</li></ul><ul id="2ab568fa-e39f-808a-bd7a-d8b90b8e83d5" class="bulleted-list"><li style="list-style-type:disc"><code>gradient_accumulation_steps=k</code>:<ul id="2ab568fa-e39f-8014-9fef-e10f72f50dc8" class="bulleted-list"><li style="list-style-type:circle">–º—ã –¥–µ–ª–∞–µ–º k <em>forward+backward</em> –ø—Ä–æ—Ö–æ–¥–æ–≤ <strong>–¥–æ</strong> –æ–¥–Ω–æ–≥–æ <code>optimizer.step()</code>,</li></ul><ul id="2ab568fa-e39f-80a6-90c3-c07224533634" class="bulleted-list"><li style="list-style-type:circle">—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π batch size = <code>per_device_train_batch_size * gradient_accumulation_steps * num_devices</code>.</li></ul></li></ul><p id="2ab568fa-e39f-80ad-b5fa-d133478c32e0" class="">–ü—Ä–∏–º–µ—Ä:</p><p id="2ab568fa-e39f-804c-aa70-f030b37dd657" class=""><code>batch_size=8</code>, <code>grad_accum_steps=4</code>, <code>1 GPU</code> ‚Üí —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π batch = 32.</p><h3 id="2ab568fa-e39f-8071-a705-d2063537a9eb" class="">7.1.4. –ö–æ–¥: –∞–¥–∞–ø—Ç–∞—Ü–∏—è –Ω–∞—à–µ–≥–æ Trainer –∏–∑ –ú4</h3><p id="2ab568fa-e39f-8039-9750-d33c0d2731e9" class="">–î–æ–ø—É—Å—Ç–∏–º, –µ—Å—Ç—å –∫–æ–¥ –∏–∑ –ú4:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="2ab568fa-e39f-80c2-b414-fb90a96d0d88" class="code code-wrap"><code class="language-Python" style="white-space:pre-wrap;word-break:break-all">from transformers import TrainingArguments

training_args = TrainingArguments(
    output_dir=&quot;checkpoints/tickets_final&quot;,
    evaluation_strategy=&quot;epoch&quot;,
    save_strategy=&quot;epoch&quot;,
    learning_rate=3e-5,
    per_device_train_batch_size=16,
    per_device_eval_batch_size=32,
    num_train_epochs=4,
    weight_decay=0.01,
    warmup_ratio=0.1,
    logging_steps=20,
    load_best_model_at_end=True,
    metric_for_best_model=&quot;f1&quot;,
    report_to=[&quot;none&quot;],
)
</code></pre><p id="2ab568fa-e39f-807e-a2b5-c0f57d9b5c97" class="">–î–µ–ª–∞–µ–º ‚Äú–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—É—é‚Äù –≤–µ—Ä—Å–∏—é:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="2ab568fa-e39f-803c-b981-e23472baf55d" class="code code-wrap"><code class="language-Python" style="white-space:pre-wrap;word-break:break-all">training_args = TrainingArguments(
    output_dir=&quot;checkpoints/tickets_final_fp16&quot;,
    evaluation_strategy=&quot;epoch&quot;,
    save_strategy=&quot;epoch&quot;,
    learning_rate=3e-5,
    per_device_train_batch_size=8,      # —É–º–µ–Ω—å—à–∞–µ–º –±–∞—Ç—á, —á—Ç–æ–±—ã –≤–ª–µ–∑—Ç—å
    per_device_eval_batch_size=32,
    num_train_epochs=4,
    weight_decay=0.01,
    warmup_ratio=0.1,
    logging_steps=20,
    load_best_model_at_end=True,
    metric_for_best_model=&quot;f1&quot;,
    report_to=[&quot;none&quot;],
    fp16=True,                          # –≤–∫–ª—é—á–∞–µ–º mixed precision
    gradient_accumulation_steps=2,      # —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π batch = 8*2 = 16
)
</code></pre><p id="2ab568fa-e39f-8099-a8ca-e70d68257fd4" class="">–û–±—Å—É–∂–¥–∞–µ–º:</p><ul id="2ab568fa-e39f-800f-b180-f1390de183cd" class="bulleted-list"><li style="list-style-type:disc">–ï—Å–ª–∏ —Ä–∞–Ω—å—à–µ <code>16</code> –Ω–µ –≤–ª–µ–∑–∞–ª–æ, —Ç–µ–ø–µ—Ä—å:<ul id="2ab568fa-e39f-80ac-97a0-e41919b865d1" class="bulleted-list"><li style="list-style-type:circle">–º–æ–¥–µ–ª—å –≤ <code>fp16</code> ‚Üí –º–µ–Ω—å—à–µ –ø–∞–º—è—Ç–∏,</li></ul><ul id="2ab568fa-e39f-8088-8ab3-cbd7e05f77d8" class="bulleted-list"><li style="list-style-type:circle">–±–∞—Ç—á 8, –Ω–æ –∞–∫–∫—É–º—É–ª–∏–Ω–≥ –Ω–∞ 2 —à–∞–≥–∞ ‚Üí –ø–æ –≥—Ä–∞–¥–∏–µ–Ω—Ç–∞–º —ç—Ç–æ –∫–∞–∫ 16.</li></ul></li></ul><ul id="2ab568fa-e39f-801f-961a-ff7d6a969d54" class="bulleted-list"><li style="list-style-type:disc">–ú–æ–∂–Ω–æ –∏–≥—Ä–∞—Ç—å—Å—è:<ul id="2ab568fa-e39f-8025-a9bf-d6a8d110c76f" class="bulleted-list"><li style="list-style-type:circle">—É–º–µ–Ω—å—à–∞—Ç—å <code>per_device_train_batch_size</code> –¥–æ —Ç–µ—Ö –ø–æ—Ä, –ø–æ–∫–∞ –Ω–µ –ø–µ—Ä–µ—Å—Ç–∞–Ω–µ—Ç –±—ã—Ç—å OOM,</li></ul><ul id="2ab568fa-e39f-8039-8cf8-cbdc47b6a826" class="bulleted-list"><li style="list-style-type:circle">–∫–æ–º–ø–µ–Ω—Å–∏—Ä–æ–≤–∞—Ç—å <code>gradient_accumulation_steps</code>.</li></ul></li></ul><h3 id="2ab568fa-e39f-80db-8f03-d7297f3cd34f" class="">7.1.5. –î–æ–º–∞—à–∫–∞ 7.1</h3><ol type="1" id="2ab568fa-e39f-8081-9147-c95d0b1a2924" class="numbered-list" start="1"><li>–í–∑—è—Ç—å —Å–≤–æ—é –∑–∞–¥–∞—á—É –∏–∑ –ú4 (–∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è —Ç–∏–∫–µ—Ç–æ–≤):<ul id="2ab568fa-e39f-801f-a07f-d5b65e5abc87" class="bulleted-list"><li style="list-style-type:disc">—Å–Ω–∞—á–∞–ª–∞ –æ–±—É—á–∏—Ç—å –±–µ–∑ <code>fp16</code> –∏ –∞–∫–∫—É–º–ª–∏–Ω–≥–∞,</li></ul><ul id="2ab568fa-e39f-8065-b2b7-ed7ef4ee3f28" class="bulleted-list"><li style="list-style-type:disc">–∑–∞–º–µ—Ä–∏—Ç—å:<ul id="2ab568fa-e39f-806a-8e15-dd9da2823018" class="bulleted-list"><li style="list-style-type:circle">–≤—Ä–µ–º—è –Ω–∞ —ç–ø–æ—Ö—É,</li></ul><ul id="2ab568fa-e39f-80a9-adec-f6a0c8e3186a" class="bulleted-list"><li style="list-style-type:circle">–ª—É—á—à—É—é F1.</li></ul></li></ul></li></ol><ol type="1" id="2ab568fa-e39f-8051-9352-fc9305919f10" class="numbered-list" start="2"><li>–ü–æ—Ç–æ–º:<ul id="2ab568fa-e39f-8040-8e0c-f7119d569de1" class="bulleted-list"><li style="list-style-type:disc">–≤–∫–ª—é—á–∏—Ç—å <code>fp16=True</code>,</li></ul><ul id="2ab568fa-e39f-8008-99ea-f3b0af0ebc17" class="bulleted-list"><li style="list-style-type:disc">—É–º–µ–Ω—å—à–∏—Ç—å <code>per_device_train_batch_size</code>,</li></ul><ul id="2ab568fa-e39f-80e3-a4de-df62057f0df1" class="bulleted-list"><li style="list-style-type:disc">–¥–æ–±–∞–≤–∏—Ç—å <code>gradient_accumulation_steps</code>,</li></ul><ul id="2ab568fa-e39f-8012-b0ef-c108bf12933b" class="bulleted-list"><li style="list-style-type:disc">—Å–Ω–æ–≤–∞ –∑–∞–º–µ—Ä–∏—Ç—å –≤—Ä–µ–º—è –∏ –∫–∞—á–µ—Å—Ç–≤–æ.</li></ul></li></ol><ol type="1" id="2ab568fa-e39f-8021-a391-fc4789e8bd73" class="numbered-list" start="3"><li>–ù–∞–ø–∏—Å–∞—Ç—å –ø–∞—Ä—É –≤—ã–≤–æ–¥–æ–≤:<ul id="2ab568fa-e39f-80af-b1fd-d37911bf9d38" class="bulleted-list"><li style="list-style-type:disc">–ø–æ–ª—É—á–∏–ª–æ—Å—å –ª–∏ —É—Å–∫–æ—Ä–∏—Ç—å,</li></ul><ul id="2ab568fa-e39f-80a2-90df-f5ac9165d082" class="bulleted-list"><li style="list-style-type:disc">–∫–∞–∫ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏ (–ø–æ –æ—â—É—â–µ–Ω–∏—è–º / <code>nvidia-smi</code>),</li></ul><ul id="2ab568fa-e39f-8047-92bf-e468ad0e0f77" class="bulleted-list"><li style="list-style-type:disc">—É–ø–∞–ª–æ –ª–∏ –∫–∞—á–µ—Å—Ç–≤–æ.</li></ul></li></ol><hr id="2ab568fa-e39f-807a-b4a7-ca617253ef90"/><h2 id="2ab568fa-e39f-8092-bf33-dcc2f28a6768" class="">–£—Ä–æ–∫ 7.2. Accelerate + —Å–≤–æ–π train loop</h2><p id="2ab568fa-e39f-80c3-bdcd-f7fae4c22056" class=""><strong>–¶–µ–ª—å:</strong></p><p id="2ab568fa-e39f-802b-9149-daa7c49302ef" class="">–ù–∞—É—á–∏—Ç—å:</p><ul id="2ab568fa-e39f-801b-957e-e26ffaee2a86" class="bulleted-list"><li style="list-style-type:disc">–±–∞–∑–æ–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è <code>accelerate</code> –¥–ª—è —Å–≤–æ–µ–≥–æ train loop,</li></ul><ul id="2ab568fa-e39f-8054-be7b-e917798f2e5b" class="bulleted-list"><li style="list-style-type:disc">–ø–∏—Å–∞—Ç—å –∫–∞—Å—Ç–æ–º–Ω—ã–π —Ü–∏–∫–ª –æ–±—É—á–µ–Ω–∏—è –±–µ–∑ Trainer (–Ω–æ —Å –º—É–ª—å—Ç–∏-GPU/–º—É–ª—å—Ç–∏-device –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π),</li></ul><ul id="2ab568fa-e39f-8006-8650-e2e2cf596d61" class="bulleted-list"><li style="list-style-type:disc">–ø–æ–Ω–∏–º–∞—Ç—å, –∫–∞–∫ –æ–±–æ—Ä–∞—á–∏–≤–∞—Ç—å –º–æ–¥–µ–ª—å, –æ–ø—Ç–∏–º–∏–∑–∞—Ç–æ—Ä, –¥–∞—Ç–∞–ª–æ–∞–¥–µ—Ä.</li></ul><h3 id="2ab568fa-e39f-802a-9f62-f8be051ba74f" class="">7.2.1. –ö–µ–π—Å</h3><blockquote id="2ab568fa-e39f-80ad-a73a-dad7fea22665" class="">–ù–∞–º –∏–Ω–æ–≥–¥–∞ –Ω—É–∂–µ–Ω –ø–æ–ª–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å:<ul id="2ab568fa-e39f-8010-a48a-c385444ff057" class="bulleted-list"><li style="list-style-type:disc">–Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ª–æ—Å—Å,</li></ul><ul id="2ab568fa-e39f-80d2-ae6c-fb57407fa2c1" class="bulleted-list"><li style="list-style-type:disc">–Ω–µ—Å–∫–æ–ª—å–∫–æ –º–æ–¥–µ–ª–µ–π,</li></ul><ul id="2ab568fa-e39f-80fd-b831-c17d89d541dd" class="bulleted-list"><li style="list-style-type:disc">—Å–ª–æ–∂–Ω–∞—è –ª–æ–≥–∏–∫–∞ –æ–±—É—á–µ–Ω–∏—è.</li></ul><p id="2ab568fa-e39f-8071-9307-d47f66a60092" class=""><code>Trainer</code> —É–¥–æ–±–µ–Ω, –Ω–æ –Ω–µ –≤—Å–µ–≥–¥–∞ –≥–∏–±–æ–∫.</p><p id="2ab568fa-e39f-8015-bec3-fcec37081452" class="">–ü–æ—ç—Ç–æ–º—É –º—ã –¥–µ–ª–∞–µ–º <strong>—Å–≤–æ–π —Ü–∏–∫–ª</strong>, –Ω–æ —Å –ø–æ–º–æ—â—å—é <code>Accelerator</code>:</p><ul id="2ab568fa-e39f-8091-85da-d3ca9ff8b2c8" class="bulleted-list"><li style="list-style-type:disc">—á—Ç–æ–±—ã –Ω–µ —Å—Ç—Ä–∞–¥–∞—Ç—å —Å <code>.to(device)</code>/DDP –≤—Ä—É—á–Ω—É—é.</li></ul></blockquote><h3 id="2ab568fa-e39f-8073-a22b-cbb97571cf76" class="">7.2.2. –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ü–∏–∫–ª –æ–±—É—á–µ–Ω–∏—è –¥–ª—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞ —Ç–∏–∫–µ—Ç–æ–≤</h3><p id="2ab568fa-e39f-80e1-b918-c7462854dc63" class="">–ü—Ä–µ–¥–ø–æ–ª–æ–∂–∏–º, —É –Ω–∞—Å —É–∂–µ –µ—Å—Ç—å:</p><ul id="2ab568fa-e39f-80a4-b35f-f821c3d357c6" class="bulleted-list"><li style="list-style-type:disc"><code>tokenized_dataset</code> –∏ <code>data_collator</code> –∏–∑ –ú3,</li></ul><ul id="2ab568fa-e39f-802e-83d1-ea47b9a10a69" class="bulleted-list"><li style="list-style-type:disc">–º–æ–¥–µ–ª—å <code>AutoModelForSequenceClassification</code> –∏–∑ –ú4.</li></ul><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="2ab568fa-e39f-80a0-85eb-da2315c74942" class="code code-wrap"><code class="language-Python" style="white-space:pre-wrap;word-break:break-all">from torch.utils.data import DataLoader
from transformers import AutoModelForSequenceClassification, AutoTokenizer
from accelerate import Accelerator
import torch
from data_pipeline import load_and_prepare_data
</code></pre><p id="2ab568fa-e39f-8076-93c8-eecd7e8fc949" class="">–°–æ–±–∏—Ä–∞–µ–º:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="2ab568fa-e39f-80b5-ae14-d3966805ff10" class="code code-wrap"><code class="language-Python" style="white-space:pre-wrap;word-break:break-all">def train_with_accelerate(
    csv_path: str,
    model_name: str = &quot;distilbert-base-uncased&quot;,
    num_epochs: int = 3,
    lr: float = 2e-5,
    batch_size: int = 16,
):
    accelerator = Accelerator()  # —Å–∞–º —Ä–∞–∑—Ä—É–ª–∏—Ç device, fp16/bf16 –∏ —Ç.–¥.

    # 1. –î–∞–Ω–Ω—ã–µ
    tokenized_dataset, label2id, id2label, tokenizer, data_collator = load_and_prepare_data(
        csv_path=csv_path,
        model_name=model_name,
        max_length=128,
        test_size=0.1,
        seed=42,
    )

    train_dataset = tokenized_dataset[&quot;train&quot;]
    val_dataset = tokenized_dataset[&quot;validation&quot;]

    train_dataloader = DataLoader(
        train_dataset, batch_size=batch_size, shuffle=True, collate_fn=data_collator
    )
    val_dataloader = DataLoader(
        val_dataset, batch_size=batch_size, shuffle=False, collate_fn=data_collator
    )

    # 2. –ú–æ–¥–µ–ª—å –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ç–æ—Ä
    num_labels = len(label2id)
    model = AutoModelForSequenceClassification.from_pretrained(
        model_name,
        num_labels=num_labels,
        id2label=id2label,
        label2id=label2id,
    )

    optimizer = torch.optim.AdamW(model.parameters(), lr=lr)

    # 3. –û–±–æ—Ä–∞—á–∏–≤–∞–µ–º –≤—Å—ë –≤ accelerator
    model, optimizer, train_dataloader, val_dataloader = accelerator.prepare(
        model, optimizer, train_dataloader, val_dataloader
    )

    # 4. –¶–∏–∫–ª –æ–±—É—á–µ–Ω–∏—è
    for epoch in range(num_epochs):
        model.train()
        total_loss = 0.0
        for batch in train_dataloader:
            optimizer.zero_grad()
            outputs = model(
                input_ids=batch[&quot;input_ids&quot;],
                attention_mask=batch[&quot;attention_mask&quot;],
                labels=batch[&quot;labels&quot;],
            )
            loss = outputs.loss
            accelerator.backward(loss)
            optimizer.step()
            total_loss += loss.item()

        avg_train_loss = total_loss / len(train_dataloader)

        # Eval
        model.eval()
        total_eval_loss = 0.0
        correct = 0
        total = 0

        for batch in val_dataloader:
            with torch.no_grad():
                outputs = model(
                    input_ids=batch[&quot;input_ids&quot;],
                    attention_mask=batch[&quot;attention_mask&quot;],
                    labels=batch[&quot;labels&quot;],
                )
            loss = outputs.loss
            logits = outputs.logits
            total_eval_loss += loss.item()

            preds = torch.argmax(logits, dim=-1)
            correct += (preds == batch[&quot;labels&quot;]).sum().item()
            total += batch[&quot;labels&quot;].size(0)

        avg_eval_loss = total_eval_loss / len(val_dataloader)
        accuracy = correct / total if total &gt; 0 else 0.0

        accelerator.print(
            f&quot;Epoch {epoch+1}/{num_epochs} | train_loss={avg_train_loss:.4f} | &quot;
            f&quot;val_loss={avg_eval_loss:.4f} | val_acc={accuracy:.4f}&quot;
        )

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –º–æ–¥–µ–ª—å (—Å —É—á—ë—Ç–æ–º unwrap)
    unwrapped_model = accelerator.unwrap_model(model)
    unwrapped_model.save_pretrained(&quot;models/tickets_accelerate&quot;)
    tokenizer.save_pretrained(&quot;models/tickets_accelerate&quot;)
</code></pre><p id="2ab568fa-e39f-80d8-ae36-e12c4ce7555e" class="">–û–±—ä—è—Å–Ω—è–µ–º –≤–∞–∂–Ω—ã–µ —à—Ç—É–∫–∏:</p><ul id="2ab568fa-e39f-8050-977a-c4d8f93b22d3" class="bulleted-list"><li style="list-style-type:disc"><code>Accelerator()</code>:<ul id="2ab568fa-e39f-80c6-a9e3-c6b0143cca51" class="bulleted-list"><li style="list-style-type:circle">—Å–∞–º –≤—ã–±–∏—Ä–∞–µ—Ç device,</li></ul><ul id="2ab568fa-e39f-8044-b849-e4d8b8964e6c" class="bulleted-list"><li style="list-style-type:circle">—É–º–µ–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Å <code>fp16/bf16</code> –ø—Ä–∏ –∫–æ–Ω—Ñ–∏–≥–∞—Ö,</li></ul><ul id="2ab568fa-e39f-80f3-85d7-c3ef477267c7" class="bulleted-list"><li style="list-style-type:circle">–µ—Å–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ GPU ‚Äî —Å–∞–º —Å—Ç–∞–≤–∏—Ç DDP.</li></ul></li></ul><ul id="2ab568fa-e39f-80cb-9ed6-fba0a0b976bf" class="bulleted-list"><li style="list-style-type:disc"><code>accelerator.prepare(...)</code>:<ul id="2ab568fa-e39f-8033-807d-c9e8a19ba056" class="bulleted-list"><li style="list-style-type:circle">‚Äú–æ–±–æ—Ä–∞—á–∏–≤–∞–µ—Ç‚Äù –º–æ–¥–µ–ª—å, –æ–ø—Ç–∏–º–∏–∑–∞—Ç–æ—Ä –∏ dataloader‚Äô—ã.</li></ul></li></ul><ul id="2ab568fa-e39f-8033-a77a-e33e16620c17" class="bulleted-list"><li style="list-style-type:disc">–î–ª—è –ª–æ–≥–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º <code>accelerator.print</code>, —á—Ç–æ–±—ã –Ω–µ –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ –∫–∞–∂–¥–æ–º –ø—Ä–æ—Ü–µ—Å—Å–µ.</li></ul><h3 id="2ab568fa-e39f-809a-8487-db92ad736ff4" class="">7.2.3. –î–æ–º–∞—à–∫–∞ 7.2</h3><ol type="1" id="2ab568fa-e39f-8033-9d67-c427f24a55b4" class="numbered-list" start="1"><li>–ü–µ—Ä–µ–ø–∏—Å–∞—Ç—å –æ–±—É—á–µ–Ω–∏–µ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞ –∏–∑ –ú4 –Ω–∞ <code>accelerate</code>:<ul id="2ab568fa-e39f-8055-9fc7-ff47914002d3" class="bulleted-list"><li style="list-style-type:disc">–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–æ—á—Ç–∏ —Ç–æ—Ç –∂–µ –∫–æ–¥, —á—Ç–æ –≤—ã—à–µ.</li></ul></li></ol><ol type="1" id="2ab568fa-e39f-80de-9511-e5530fe947ec" class="numbered-list" start="2"><li>–°—Ä–∞–≤–Ω–∏—Ç—å:<ul id="2ab568fa-e39f-8025-9d5a-c3c24329ebdf" class="bulleted-list"><li style="list-style-type:disc">–∫–∞—á–µ—Å—Ç–≤–æ (accuracy/F1),</li></ul><ul id="2ab568fa-e39f-806d-8fd8-d2d122cf49a0" class="bulleted-list"><li style="list-style-type:disc">—Å–∫–æ—Ä–æ—Å—Ç—å (–ø—Ä–∏–º–µ—Ä–Ω–æ),</li></ul><ul id="2ab568fa-e39f-8016-9478-fb952757d501" class="bulleted-list"><li style="list-style-type:disc">–∫–∞–∫ –≤—ã–≥–ª—è–¥–∏—Ç –ª–æ–≥–∏–∫–∞ vs Trainer.</li></ul></li></ol><ol type="1" id="2ab568fa-e39f-8079-af28-fdc7e7dec2f2" class="numbered-list" start="3"><li>(–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –ù–∞—Å—Ç—Ä–æ–∏—Ç—å <code>Accelerator(fp16=True)</code> –∏–ª–∏ –∫–æ–Ω—Ñ–∏–≥ —á–µ—Ä–µ–∑ CLI (<code>accelerate config</code>) –∏ —Å—Ä–∞–≤–Ω–∏—Ç—å –ø–∞–º—è—Ç—å.</li></ol><hr id="2ab568fa-e39f-8063-85f6-daecf6f63276"/><h2 id="2ab568fa-e39f-80e7-8dae-e2e42b895b25" class="">–£—Ä–æ–∫ 7.3. –ë–æ–ª—å—à–∏–µ –º–æ–¥–µ–ª–∏: device_map, offload, 8-bit/4-bit –∫–≤–∞–Ω—Ç–æ–≤–∞–Ω–∏–µ</h2><p id="2ab568fa-e39f-800b-b028-d5d0c822d468" class=""><strong>–¶–µ–ª—å:</strong></p><p id="2ab568fa-e39f-8023-b2fd-fcf9599f244c" class="">–ù–∞—É—á–∏—Ç—å:</p><ul id="2ab568fa-e39f-80b1-a94e-f88ab97f6be5" class="bulleted-list"><li style="list-style-type:disc">–≥—Ä—É–∑–∏—Ç—å <strong>–±–æ–ª—å—à–∏–µ</strong> –º–æ–¥–µ–ª–∏, –∫–æ—Ç–æ—Ä—ã–µ —Ü–µ–ª–∏–∫–æ–º –Ω–µ –≤–ª–µ–∑–∞—é—Ç –≤ GPU,</li></ul><ul id="2ab568fa-e39f-80cf-8559-d8aba02fce07" class="bulleted-list"><li style="list-style-type:disc">–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å <code>device_map=&quot;auto&quot;</code> –∏ offloading,</li></ul><ul id="2ab568fa-e39f-802a-ac6c-d83bef68be77" class="bulleted-list"><li style="list-style-type:disc">–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å 8-bit/4-bit-–∑–∞–≥—Ä—É–∑–∫—É (<code>load_in_8bit</code>, <code>load_in_4bit</code>) –¥–ª—è –∏–Ω—Ñ–µ—Ä–µ–Ω—Å–∞.</li></ul><h3 id="2ab568fa-e39f-802f-a287-e1c56ea5afaa" class="">7.3.1. –ö–µ–π—Å</h3><blockquote id="2ab568fa-e39f-80a2-bf88-d205329f527a" class="">–í –ú6 –º—ã –¥–µ–ª–∞–ª–∏ —Å–∞–ø–ø–æ—Ä—Ç-–±–æ—Ç–∞ –Ω–∞ —Å—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω–æ –º–∞–ª–µ–Ω—å–∫–æ–π –º–æ–¥–µ–ª–∏.<p id="2ab568fa-e39f-804c-b98c-da2995a0beca" class="">–¢–µ–ø–µ—Ä—å —Ö–æ—Ç–∏–º:</p><ul id="2ab568fa-e39f-8006-a8bc-cf5ff77880c2" class="bulleted-list"><li style="list-style-type:disc">–≤–∑—è—Ç—å –º–æ–¥–µ–ª—å –ø–æ–±–æ–ª—å—à–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 7B),</li></ul><ul id="2ab568fa-e39f-8053-b71a-c5fde1fed83c" class="bulleted-list"><li style="list-style-type:disc">–∑–∞–ø—É—Å—Ç–∏—Ç—å –µ—ë:<ul id="2ab568fa-e39f-80a3-9a94-eb0f5c2cf58f" class="bulleted-list"><li style="list-style-type:circle">–ª–∏–±–æ —Å —á–∞—Å—Ç–∏—á–Ω—ã–º —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ–º GPU+CPU,</li></ul><ul id="2ab568fa-e39f-805f-b82c-dda04effe30d" class="bulleted-list"><li style="list-style-type:circle">–ª–∏–±–æ –≤ 8-bit/4-bit –≤–∞—Ä–∏–∞–Ω—Ç–µ,</li></ul></li></ul><ul id="2ab568fa-e39f-80e3-827c-fd4bbc38e64f" class="bulleted-list"><li style="list-style-type:disc">—á—Ç–æ–±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –µ—ë –¥–ª—è –∏–Ω—Ñ–µ—Ä–µ–Ω—Å–∞ –≤ –ø—Ä–æ–¥–µ.</li></ul></blockquote><h3 id="2ab568fa-e39f-8072-907c-e895a5e8bbaa" class="">7.3.2. device_map=&quot;auto&quot; –∏ offload</h3><p id="2ab568fa-e39f-80b1-ba07-fe3c87d74ff3" class="">–î–ª—è –±–æ–ª—å—à–∏—Ö –º–æ–¥–µ–ª–µ–π:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="2ab568fa-e39f-80ba-9d93-f03ce36206bd" class="code code-wrap"><code class="language-Python" style="white-space:pre-wrap;word-break:break-all">from transformers import AutoTokenizer, AutoModelForCausalLM

model_name = &quot;big-llm/checkpoint&quot;  # –ø—Ä–∏–º–µ—Ä

tokenizer = AutoTokenizer.from_pretrained(model_name)

model = AutoModelForCausalLM.from_pretrained(
    model_name,
    device_map=&quot;auto&quot;,            # —Å–∞–º —Ä–∞—Å–∫–∏–¥–∞–µ—Ç –ø–æ –¥–æ—Å—Ç—É–ø–Ω—ã–º GPU/CPU
    torch_dtype=&quot;auto&quot;,           # –ø–æ–¥–±–µ—Ä—ë—Ç –ø–æ–¥—Ö–æ–¥—è—â–∏–π —Ç–∏–ø
)
</code></pre><p id="2ab568fa-e39f-80f3-bdda-f92c87bdc9a0" class="">–ú–æ–∂–Ω–æ –µ—â—ë:</p><ul id="2ab568fa-e39f-8055-a4d5-e7df4ca24b2d" class="bulleted-list"><li style="list-style-type:disc"><code>max_memory</code> –∑–∞–¥–∞—Ç—å —Å–ª–æ–≤–∞—Ä—ë–º: —Å–∫–æ–ª—å–∫–æ –ø–∞–º—è—Ç–∏ –Ω–∞ –∫–∞–∂–¥–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ,</li></ul><ul id="2ab568fa-e39f-8031-a5d4-d38bf862d38b" class="bulleted-list"><li style="list-style-type:disc">–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å <code>offload_folder</code> (–¥–ª—è CPU/disk offload) ‚Äî –¥–ª—è –æ—á–µ–Ω—å –±–æ–ª—å—à–∏—Ö –º–æ–¥–µ–ª–µ–π.</li></ul><p id="2ab568fa-e39f-804d-a564-d7ba8cec6807" class="">–ü—Ä–∏–º–µ—Ä —Å offload –Ω–∞ CPU/SSD:</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="2ab568fa-e39f-800c-af8e-f77b1de5189a" class="code code-wrap"><code class="language-Python" style="white-space:pre-wrap;word-break:break-all">model = AutoModelForCausalLM.from_pretrained(
    model_name,
    device_map=&quot;auto&quot;,
    offload_folder=&quot;offload&quot;,
    torch_dtype=&quot;auto&quot;,
)
</code></pre><h3 id="2ab568fa-e39f-807a-81b9-ea9698dd812d" class="">7.3.3. 8-bit / 4-bit –∑–∞–≥—Ä—É–∑–∫–∞ (–∏–Ω—Ñ–µ—Ä–µ–Ω—Å)</h3><p id="2ab568fa-e39f-8056-ac09-d452fea3d58f" class="">–ß–µ—Ä–µ–∑ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å <code>bitsandbytes</code> (–µ—Å–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω):</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="2ab568fa-e39f-80d2-a7ce-fd9a1f04ece0" class="code code-wrap"><code class="language-Python" style="white-space:pre-wrap;word-break:break-all">from transformers import AutoTokenizer, AutoModelForCausalLM

model_name = &quot;big-llm/checkpoint&quot;
tokenizer = AutoTokenizer.from_pretrained(model_name)

model_8bit = AutoModelForCausalLM.from_pretrained(
    model_name,
    device_map=&quot;auto&quot;,
    load_in_8bit=True,        # –∫–≤–∞–Ω—Ç 8-–±–∏—Ç
)

# –∏–ª–∏ 4-–±–∏—Ç (—á–∞—â–µ –¥–ª—è –±–æ–ª—å—à–∏—Ö LLM):
model_4bit = AutoModelForCausalLM.from_pretrained(
    model_name,
    device_map=&quot;auto&quot;,
    load_in_4bit=True,
)
</code></pre><p id="2ab568fa-e39f-803d-9cb2-f0a02db5e2f4" class="">–û–±—Å—É–∂–¥–∞–µ–º:</p><ul id="2ab568fa-e39f-8062-ad43-dbaf4212d736" class="bulleted-list"><li style="list-style-type:disc">8-bit / 4-bit:<ul id="2ab568fa-e39f-80d0-a7e5-e977f89c943b" class="bulleted-list"><li style="list-style-type:circle">–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —ç–∫–æ–Ω–æ–º—è—Ç –ø–∞–º—è—Ç—å,</li></ul><ul id="2ab568fa-e39f-80e6-9a5c-e08991439118" class="bulleted-list"><li style="list-style-type:circle">–Ω–µ–º–Ω–æ–≥–æ/–∑–∞–º–µ—Ç–Ω–æ (4-bit) —Ä–µ–∂—É—Ç —Ç–æ—á–Ω–æ—Å—Ç—å,</li></ul><ul id="2ab568fa-e39f-8096-a8fb-dd38933b04f0" class="bulleted-list"><li style="list-style-type:circle"><strong>–æ—Ç–ª–∏—á–Ω–æ –ø–æ–¥—Ö–æ–¥—è—Ç –¥–ª—è –∏–Ω—Ñ–µ—Ä–µ–Ω—Å–∞</strong>, –æ—Å–æ–±–µ–Ω–Ω–æ –µ—Å–ª–∏ —Å–¥–µ–ª–∞–ª PEFT/LoRA.</li></ul></li></ul><h3 id="2ab568fa-e39f-8022-a4eb-ccda1a45fcaa" class="">7.3.4. –°—Ä–∞–≤–Ω–µ–Ω–∏–µ: –æ–±—ã—á–Ω–∞—è vs 8-bit –º–æ–¥–µ–ª—å</h3><p id="2ab568fa-e39f-8045-8bf4-f27cae6dfc50" class="">–ú–∏–Ω–∏-—Å–∫—Ä–∏–ø—Ç (–æ—á–µ–Ω—å —É–ø—Ä–æ—â—ë–Ω–Ω–æ):</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="2ab568fa-e39f-802c-8b25-e27e4bff976a" class="code code-wrap"><code class="language-Python" style="white-space:pre-wrap;word-break:break-all">import time
import torch
from transformers import AutoTokenizer, AutoModelForCausalLM

model_name = &quot;gpt2&quot;  # –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏, –≤–º–µ—Å—Ç–æ –±–æ–ª—å—à–æ–π

tokenizer = AutoTokenizer.from_pretrained(model_name)

text = &quot;User: The app keeps crashing.\nSupport:&quot;

# –û–±—ã—á–Ω–∞—è –º–æ–¥–µ–ª—å
model_fp32 = AutoModelForCausalLM.from_pretrained(model_name).to(&quot;cuda&quot;)

inputs = tokenizer(text, return_tensors=&quot;pt&quot;).to(&quot;cuda&quot;)

start = time.time()
with torch.no_grad():
    out_ids = model_fp32.generate(**inputs, max_new_tokens=50)
torch.cuda.synchronize()
t_fp32 = time.time() - start

# 8-bit (–µ—Å–ª–∏ –±—ã —ç—Ç–æ –±—ã–ª–∞ –±–æ–ª—å—à–∞—è –º–æ–¥–µ–ª—å)
# (–Ω–∞ –º–∞–ª–µ–Ω—å–∫–æ–π –ø—Ä–∏—Ä–æ—Å—Ç –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–æ—á–µ–≤–∏–¥–µ–Ω, –Ω–æ –∑–∞—Ç–æ –º–µ–Ω—å—à–µ –ø–∞–º—è—Ç—å)
model_8bit = AutoModelForCausalLM.from_pretrained(
    model_name,
    device_map=&quot;cuda&quot;,
    load_in_8bit=True,
)

inputs_8 = tokenizer(text, return_tensors=&quot;pt&quot;).to(&quot;cuda&quot;)

start = time.time()
with torch.no_grad():
    out_ids_8 = model_8bit.generate(**inputs_8, max_new_tokens=50)
torch.cuda.synchronize()
t_8bit = time.time() - start

print(&quot;FP32 time:&quot;, t_fp32)
print(&quot;8bit time:&quot;, t_8bit)
</code></pre><p id="2ab568fa-e39f-80e4-8a7c-e9a4165d1bf0" class="">–í–∞–∂–Ω–æ: –¥–ª—è –º–∞–ª–µ–Ω—å–∫–∏—Ö –º–æ–¥–µ–ª–µ–π —Ä–∞–∑–Ω–∏—Ü–∞ –±—É–¥–µ—Ç –º–∞–ª–µ–Ω—å–∫–æ–π, –Ω–æ <strong>–ø–æ –ø–∞–º—è—Ç–∏</strong> ‚Äî –±—É–¥–µ—Ç –∑–∞–º–µ—Ç–Ω–æ.</p><h3 id="2ab568fa-e39f-8009-b880-db2a3d4208bb" class="">7.3.5. –î–æ–º–∞—à–∫–∞ 7.3</h3><ol type="1" id="2ab568fa-e39f-80cb-9251-de17fe73f3cb" class="numbered-list" start="1"><li>–í–∑—è—Ç—å —Å–≤–æ—é –∫–∞—É–∑–∞–ª—å–Ω—É—é –º–æ–¥–µ–ª—å –∏–∑ –ú6 (–∏–ª–∏ –ª—é–±—É—é –ø–æ–±–æ–ª—å—à–µ —Å Hub).</li></ol><ol type="1" id="2ab568fa-e39f-803c-b69d-d7c4bd765480" class="numbered-list" start="2"><li>–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å:<ul id="2ab568fa-e39f-8001-8de2-fd0f44037314" class="bulleted-list"><li style="list-style-type:disc">–∑–∞–≥—Ä—É–∑–∏—Ç—å –µ—ë –æ–±—ã—á–Ω—ã–º —Å–ø–æ—Å–æ–±–æ–º,</li></ul><ul id="2ab568fa-e39f-8050-8e82-d10593603843" class="bulleted-list"><li style="list-style-type:disc">–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å <code>device_map=&quot;auto&quot;</code>,</li></ul><ul id="2ab568fa-e39f-8026-876b-e980f4d68833" class="bulleted-list"><li style="list-style-type:disc">(–µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ) –∑–∞–≥—Ä—É–∑–∏—Ç—å –≤ <code>load_in_8bit</code> –∏–ª–∏ <code>load_in_4bit</code>.</li></ul></li></ol><ol type="1" id="2ab568fa-e39f-8003-8ad4-f52a5e0497d4" class="numbered-list" start="3"><li>–°—Ä–∞–≤–Ω–∏—Ç—å:<ul id="2ab568fa-e39f-80bc-9c27-c37e4ca14fb1" class="bulleted-list"><li style="list-style-type:disc">—Å–∫–æ–ª—å–∫–æ –ø–∞–º—è—Ç–∏ –∑–∞–Ω–∏–º–∞–µ—Ç (–ø–æ <code>nvidia-smi</code>),</li></ul><ul id="2ab568fa-e39f-80d4-8ab4-c4a76e0342db" class="bulleted-list"><li style="list-style-type:disc">–∫–∞–∫ —Å–∏–ª—å–Ω–æ –º–µ–Ω—è–µ—Ç—Å—è —Å–∫–æ—Ä–æ—Å—Ç—å –∏–Ω—Ñ–µ—Ä–µ–Ω—Å–∞,</li></ul><ul id="2ab568fa-e39f-8023-adc4-dadb8305c0bc" class="bulleted-list"><li style="list-style-type:disc">–µ—Å—Ç—å –ª–∏ –∑–∞–º–µ—Ç–Ω–æ–µ —É—Ö—É–¥—à–µ–Ω–∏–µ –∫–∞—á–µ—Å—Ç–≤–∞ –æ—Ç–≤–µ—Ç–æ–≤ –Ω–∞ –≥–ª–∞–∑.</li></ul></li></ol><hr id="2ab568fa-e39f-8040-90cd-d6824dc40a98"/><h2 id="2ab568fa-e39f-80df-81d9-f93d4df7c3cd" class="">–£—Ä–æ–∫ 7.4. –ú–∏–Ω–∏-–ø—Ä–æ–µ–∫—Ç: ‚Äú–ª—ë–≥–∫–∏–π‚Äù —Å–∞–ø–ø–æ—Ä—Ç-–±–æ—Ç / —Å—É–º–º–∞—Ä–∏–∑–∞—Ç–æ—Ä –¥–ª—è –ø—Ä–æ–¥-–∏–Ω—Ñ–µ—Ä–µ–Ω—Å–∞</h2><p id="2ab568fa-e39f-80ed-855e-cbf4bd6af214" class=""><strong>–¶–µ–ª—å:</strong></p><p id="2ab568fa-e39f-8021-809a-c4eed61645ee" class="">–°–æ–±—Ä–∞—Ç—å <strong>—Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π inference-–ø–∞–π–ø–ª–∞–π–Ω</strong>:</p><ul id="2ab568fa-e39f-8042-af5d-e8ed888b84ca" class="bulleted-list"><li style="list-style-type:disc">–≤–∑—è—Ç—å –º–æ–¥–µ–ª—å (–∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä/—Å—É–º–º–∞—Ä–∏–∑–∞—Ç–æ—Ä/–±–æ—Ç),</li></ul><ul id="2ab568fa-e39f-80f3-9347-d5bc5fba9ce3" class="bulleted-list"><li style="list-style-type:disc">–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥ –∏–Ω—Ñ–µ—Ä–µ–Ω—Å:<ul id="2ab568fa-e39f-8085-a342-c46cc7f54daf" class="bulleted-list"><li style="list-style-type:circle"><code>torch_dtype=&quot;bfloat16&quot;/&quot;float16&quot;</code>,</li></ul><ul id="2ab568fa-e39f-808b-9b79-ee02afb61766" class="bulleted-list"><li style="list-style-type:circle"><code>device_map=&quot;auto&quot;</code> / –∫–≤–∞–Ω—Ç–æ–≤–∞–Ω–∏–µ,</li></ul></li></ul><ul id="2ab568fa-e39f-8054-9aa2-e4ee1bd8fa20" class="bulleted-list"><li style="list-style-type:disc">—Å–¥–µ–ª–∞—Ç—å –Ω–µ–±–æ–ª—å—à–æ–π API-—Å–∫—Ä–∏–ø—Ç (–∏–ª–∏ CLI) –¥–ª—è –±–∞—Ç—á–µ–≤–æ–≥–æ –∏–Ω—Ñ–µ—Ä–µ–Ω—Å–∞.</li></ul><h3 id="2ab568fa-e39f-808f-b491-e4e17e784182" class="">7.4.1. –ö–µ–π—Å</h3><blockquote id="2ab568fa-e39f-803b-9124-fced516ef444" class="">–ü—Ä–µ–¥—Å—Ç–∞–≤—å, —á—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å endpoint:<p id="2ab568fa-e39f-8031-8435-ffea5fde62a0" class="">‚Äú–ø–æ –≤—Ö–æ–¥–Ω–æ–º—É –¥–∏–∞–ª–æ–≥—É ‚Üí –≤–µ—Ä–Ω—É—Ç—å:</p><ul id="2ab568fa-e39f-8098-b3a1-d39c4e9b2ac4" class="bulleted-list"><li style="list-style-type:disc">–∫—Ä–∞—Ç–∫–æ–µ summary,</li></ul><ul id="2ab568fa-e39f-80be-99cf-e9972c9af8a5" class="bulleted-list"><li style="list-style-type:disc">–∫–ª–∞—Å—Å —Ç–∏–∫–µ—Ç–∞ (bug/feature/billing/other),</li></ul><ul id="2ab568fa-e39f-800a-8632-c8c6b440822f" class="bulleted-list"><li style="list-style-type:disc">—á–µ—Ä–Ω–æ–≤–∏–∫ –æ—Ç–≤–µ—Ç–∞‚Äù.</li></ul></blockquote><p id="2ab568fa-e39f-805f-9fa5-d6587cff0a01" class="">–¢—ã —É–∂–µ —É–º–µ–µ—à—å:</p><ul id="2ab568fa-e39f-8073-9618-edf1ac4e844b" class="bulleted-list"><li style="list-style-type:disc">–∫–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å —Ç–∏–∫–µ—Ç—ã (–ú4),</li></ul><ul id="2ab568fa-e39f-80c7-ae90-dea826f97fc8" class="bulleted-list"><li style="list-style-type:disc">—Å—É–º–º–∞—Ä–∏–∑–∏—Ä–æ–≤–∞—Ç—å –¥–∏–∞–ª–æ–≥ (–ú5),</li></ul><ul id="2ab568fa-e39f-8004-a3aa-e7d2d7dafb2e" class="bulleted-list"><li style="list-style-type:disc">–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç (–ú6).</li></ul><p id="2ab568fa-e39f-80bf-857d-f216c8e717cc" class="">–¢–µ–ø–µ—Ä—å –Ω—É–∂–Ω–æ:</p><ul id="2ab568fa-e39f-8047-8e84-f7151cc40bee" class="bulleted-list"><li style="list-style-type:disc">–≤—Å—ë —ç—Ç–æ —Å–æ–±—Ä–∞—Ç—å –≤ –æ–¥–∏–Ω <strong>–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–∫—Ä–∏–ø—Ç</strong>,</li></ul><ul id="2ab568fa-e39f-80c7-84fc-d610ced945a6" class="bulleted-list"><li style="list-style-type:disc">–∫–æ—Ç–æ—Ä—ã–π —Ä–∞–±–æ—Ç–∞–µ—Ç –±—ã—Å—Ç—Ä–æ –∏ –Ω–µ —É–±–∏–≤–∞–µ—Ç –∂–µ–ª–µ–∑–æ.</li></ul><h3 id="2ab568fa-e39f-805e-b8e4-faea4f1a54c0" class="">7.4.2. –ö–∞—Ä–∫–∞—Å <code>support_inference_server.py</code> (–±–µ–∑ —Ä–µ–∞–ª—å–Ω–æ–≥–æ web-—Å–µ—Ä–≤–µ—Ä–∞, –ø—Ä–æ—Å—Ç–æ —Ñ—É–Ω–∫—Ü–∏–∏)</h3><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="2ab568fa-e39f-8034-bff5-fcf4b9d262c6" class="code code-wrap"><code class="language-Python" style="white-space:pre-wrap;word-break:break-all">import torch
from transformers import (
    AutoTokenizer,
    AutoModelForSequenceClassification,
    AutoModelForSeq2SeqLM,
    AutoModelForCausalLM,
)

# –ü—É—Ç–∏ –∫ –æ–±—É—á–µ–Ω–Ω—ã–º –º–æ–¥–µ–ª—è–º
CLS_MODEL_DIR = &quot;models/tickets_classifier_final&quot;
SUMM_MODEL_DIR = &quot;models/dialog_summarizer&quot;
BOT_MODEL_DIR = &quot;models/support_causal_sft_8bit&quot;  # –¥–æ–ø—É—Å—Ç–∏–º, —Ç—ã —Å–¥–µ–ª–∞–ª 8-bit –∫–≤–∞–Ω—Ç–æ–≤–∞–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é

device = torch.device(&quot;cuda&quot; if torch.cuda.is_available() else &quot;cpu&quot;)


# 1. –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Ç–∏–∫–µ—Ç–æ–≤
cls_tokenizer = AutoTokenizer.from_pretrained(CLS_MODEL_DIR)
cls_model = AutoModelForSequenceClassification.from_pretrained(
    CLS_MODEL_DIR,
    torch_dtype=torch.float16 if device.type == &quot;cuda&quot; else torch.float32,
).to(device)


def classify_ticket(text: str):
    enc = cls_tokenizer(
        text,
        return_tensors=&quot;pt&quot;,
        truncation=True,
        max_length=128,
    ).to(device)

    with torch.no_grad():
        outputs = cls_model(**enc)
    logits = outputs.logits
    probs = torch.softmax(logits, dim=-1)[0]
    pred_id = torch.argmax(probs).item()
    id2label = cls_model.config.id2label
    return {
        &quot;label&quot;: id2label[pred_id],
        &quot;confidence&quot;: float(probs[pred_id]),
    }


# 2. –°—É–º–º–∞—Ä–∏–∑–∞—Ç–æ—Ä –¥–∏–∞–ª–æ–≥–æ–≤ (Seq2Seq)
summ_tokenizer = AutoTokenizer.from_pretrained(SUMM_MODEL_DIR)
summ_model = AutoModelForSeq2SeqLM.from_pretrained(
    SUMM_MODEL_DIR,
    torch_dtype=torch.float16 if device.type == &quot;cuda&quot; else torch.float32,
).to(device)


def summarize_dialog(dialog: str, max_new_tokens: int = 64) -&gt; str:
    inputs = summ_tokenizer(
        dialog,
        return_tensors=&quot;pt&quot;,
        truncation=True,
        max_length=512,
    ).to(device)

    with torch.no_grad():
        out_ids = summ_model.generate(
            **inputs,
            max_new_tokens=max_new_tokens,
            num_beams=4,
            no_repeat_ngram_size=3,
        )

    return summ_tokenizer.decode(out_ids[0], skip_special_tokens=True)


# 3. –ö–≤–∞–Ω—Ç–æ–≤–∞–Ω–Ω—ã–π —Å–∞–ø–ø–æ—Ä—Ç-–±–æ—Ç (Causal LM)
bot_tokenizer = AutoTokenizer.from_pretrained(BOT_MODEL_DIR)
bot_model = AutoModelForCausalLM.from_pretrained(
    BOT_MODEL_DIR,
    device_map=&quot;auto&quot;,           # –ø—É—Å—Ç—å —Å–∞–º —Ä–∞–∑—Ä—É–≥–∞–µ—Ç —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
    # load_in_8bit=True –∏–ª–∏ 4bit - –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è, —á—Ç–æ –º–æ–¥–µ–ª—å —É–∂–µ –≤ —ç—Ç–æ–º —Ñ–æ—Ä–º–∞—Ç–µ
)

def build_prompt(dialog: str, summary: str) -&gt; str:
    # –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å summary –¥–ª—è –ø–æ–¥—Å–∫–∞–∑–∫–∏:
    prompt = (
        &quot;System: You are a concise, polite support assistant.\n&quot;
        f&quot;Summary of conversation: {summary}\n\n&quot;
        f&quot;User: {dialog.strip()}\nSupport:&quot;
    )
    return prompt


def generate_reply(dialog: str, summary: str, max_new_tokens: int = 80) -&gt; str:
    prompt = build_prompt(dialog, summary)
    inputs = bot_tokenizer(prompt, return_tensors=&quot;pt&quot;, truncation=True, max_length=512).to(bot_model.device)

    with torch.no_grad():
        out_ids = bot_model.generate(
            **inputs,
            max_new_tokens=max_new_tokens,
            do_sample=True,
            top_p=0.9,
            temperature=0.7,
            repetition_penalty=1.1,
        )

    full_text = bot_tokenizer.decode(out_ids[0], skip_special_tokens=True)
    # –û–±—Ä–µ–∑–∞–µ–º –ø–æ &quot;Support:&quot; –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
    if &quot;Support:&quot; in full_text:
        reply = full_text.split(&quot;Support:&quot;)[-1].strip()
    else:
        reply = full_text.strip()
    return reply


# 4. –ö–æ–º–ø–æ–∑–∏—Ç–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
def handle_dialog(dialog: str):
    summary = summarize_dialog(dialog)
    cls_result = classify_ticket(dialog)
    reply = generate_reply(dialog, summary)

    return {
        &quot;summary&quot;: summary,
        &quot;ticket_class&quot;: cls_result[&quot;label&quot;],
        &quot;ticket_confidence&quot;: cls_result[&quot;confidence&quot;],
        &quot;reply&quot;: reply,
    }


if __name__ == &quot;__main__&quot;:
    dialog = &quot;&quot;&quot;
User: Hi, the app keeps crashing when I open the gallery after the last update.
Support: I&#x27;m sorry about that. Could you share your device model and OS version?
User: iPhone 13, iOS 17.1, app version 5.2.1.
&quot;&quot;&quot;
    result = handle_dialog(dialog)
    print(&quot;SUMMARY:\n&quot;, result[&quot;summary&quot;])
    print(&quot;CLASS:&quot;, result[&quot;ticket_class&quot;], f&quot;({result[&#x27;ticket_confidence&#x27;]:.3f})&quot;)
    print(&quot;REPLY:\n&quot;, result[&quot;reply&quot;])
</code></pre><h3 id="2ab568fa-e39f-80f1-8ecc-c9fa0342172e" class="">7.4.3. –î–æ–º–∞—à–∫–∞ 7.4 (–∏—Ç–æ–≥–æ–≤–∞—è –ø–æ –º–æ–¥—É–ª—é)</h3><ol type="1" id="2ab568fa-e39f-80be-8867-c3254e730206" class="numbered-list" start="1"><li>–°–æ–±—Ä–∞—Ç—å —É —Å–µ–±—è –∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã–π inference-—Å–∫—Ä–∏–ø—Ç:<ul id="2ab568fa-e39f-8077-9193-d3d5d7e59291" class="bulleted-list"><li style="list-style-type:disc">–º–∏–Ω–∏–º—É–º: <strong>–æ–¥–Ω–∞</strong> –º–æ–¥–µ–ª—å (–∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä <strong>–∏–ª–∏</strong> —Å—É–º–º–∞—Ä–∏–∑–∞—Ç–æ—Ä <strong>–∏–ª–∏</strong> –±–æ—Ç),</li></ul><ul id="2ab568fa-e39f-80df-a5a2-e4d8d9ef45c9" class="bulleted-list"><li style="list-style-type:disc">–ª—É—á—à–µ ‚Äî –∫–æ–º–ø–æ–∑–∏—Ü–∏—è (summary + reply).</li></ul></li></ol><ol type="1" id="2ab568fa-e39f-8065-a5aa-e604d7321b13" class="numbered-list" start="2"><li>–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å:<ul id="2ab568fa-e39f-80f0-bc11-d21b60a9d628" class="bulleted-list"><li style="list-style-type:disc">–≤—ã—Å—Ç–∞–≤–∏—Ç—å <code>torch_dtype</code> (fp16/bf16 –Ω–∞ GPU, fp32 –Ω–∞ CPU),</li></ul><ul id="2ab568fa-e39f-8046-b0dd-fbbbffd86d03" class="bulleted-list"><li style="list-style-type:disc">–µ—Å–ª–∏ –µ—Å—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å ‚Äî –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å 8-bit/4-bit –¥–ª—è –∫–∞—É–∑–∞–ª–∫–∏.</li></ul></li></ol><ol type="1" id="2ab568fa-e39f-80e4-bd70-d8e1b90e23de" class="numbered-list" start="3"><li>–ü–æ—Ç–µ—Å—Ç–∏—Ç—å:<ul id="2ab568fa-e39f-80fb-9d31-c7cb085e7663" class="bulleted-list"><li style="list-style-type:disc">–ø—Ä–æ–≥–Ω–∞—Ç—å 10‚Äì20 –¥–∏–∞–ª–æ–≥–æ–≤,</li></ul><ul id="2ab568fa-e39f-8097-85cc-cb0a1a0b3290" class="bulleted-list"><li style="list-style-type:disc">–ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ (–≥—Ä—É–±–æ, ‚Äú–Ω–∞ –≥–ª–∞–∑‚Äù),</li></ul><ul id="2ab568fa-e39f-8019-b577-e040f2ea3c71" class="bulleted-list"><li style="list-style-type:disc">—É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –≤—Å—ë –Ω–µ –ø–∞–¥–∞–µ—Ç –ø–æ –ø–∞–º—è—Ç–∏.</li></ul></li></ol><hr id="2ab568fa-e39f-80e6-a347-f9310a9a720f"/><h2 id="2ab568fa-e39f-800f-a305-dd29f18bed3b" class="">–ß—Ç–æ —É—á–µ–Ω–∏–∫ —É–º–µ–µ—Ç –ø–æ—Å–ª–µ –º–æ–¥—É–ª—è 7</h2><p id="2ab568fa-e39f-809e-abd8-f862185b8de9" class="">–ù–∞ —ç—Ç–æ–º —É—Ä–æ–≤–Ω–µ —á–µ–ª–æ–≤–µ–∫ —É–∂–µ:</p><ul id="2ab568fa-e39f-8053-aeb3-c840f48cbed0" class="bulleted-list"><li style="list-style-type:disc">—É–≤–µ—Ä–µ–Ω–Ω–æ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç <strong>fp16/bf16</strong> –∏ <code>gradient_accumulation_steps</code> –≤ <code>Trainer</code>,</li></ul><ul id="2ab568fa-e39f-80bb-8bc3-c704a18db1e7" class="bulleted-list"><li style="list-style-type:disc">–ø–æ–Ω–∏–º–∞–µ—Ç, —á—Ç–æ —Ç–∞–∫–æ–µ <strong>—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π batch size</strong>,</li></ul><ul id="2ab568fa-e39f-8081-b6d3-c90db37ec339" class="bulleted-list"><li style="list-style-type:disc">—É–º–µ–µ—Ç –ø–∏—Å–∞—Ç—å <strong>—Å–≤–æ–π train loop</strong> –Ω–∞ <code>accelerate</code> –¥–ª—è –ø–æ–ª–Ω–æ–π –≥–∏–±–∫–æ—Å—Ç–∏,</li></ul><ul id="2ab568fa-e39f-80ae-91e4-ce90aa00c2d8" class="bulleted-list"><li style="list-style-type:disc">–∑–Ω–∞–µ—Ç, –∫–∞–∫:<ul id="2ab568fa-e39f-8043-88f8-f79caafd3d0c" class="bulleted-list"><li style="list-style-type:circle">–≥—Ä—É–∑–∏—Ç—å –∏ –≥–æ–Ω—è—Ç—å <strong>–±–æ–ª—å—à–∏–µ –º–æ–¥–µ–ª–∏</strong> —Å <code>device_map=&quot;auto&quot;</code> –∏ offload‚Äô–æ–º,</li></ul><ul id="2ab568fa-e39f-80c1-9be6-de9af78c84b5" class="bulleted-list"><li style="list-style-type:circle">–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å <strong>8-bit/4-bit</strong>–∫–≤–∞–Ω—Ç–æ–≤–∞–Ω–∏–µ –¥–ª—è –∏–Ω—Ñ–µ—Ä–µ–Ω—Å–∞,</li></ul></li></ul><ul id="2ab568fa-e39f-8065-87bc-e2b2075c8eb6" class="bulleted-list"><li style="list-style-type:disc">—Å–æ–±—Ä–∞–ª <strong>–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π inference-–ø–∞–π–ø–ª–∞–π–Ω</strong> –¥–ª—è —Å–≤–æ–µ–≥–æ NLP-–ø—Ä–æ–¥—É–∫—Ç–∞ (–∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä/—Å—É–º–º–∞—Ä–∏–∑–∞—Ç–æ—Ä/–±–æ—Ç).</li></ul><p id="2ab568fa-e39f-8015-a78e-ff70e5671557" class="">–î–∞–ª—å—à–µ –ª–æ–≥–∏—á–Ω—ã–π —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥ ‚Äî –º–æ–¥—É–ª—å 8 –ø—Ä–æ <strong>PEFT/LoRA</strong>:</p><p id="2ab568fa-e39f-8027-8a29-e4864f8c95ca" class="">–∫–∞–∫ –¥–æ–æ–±—É—á–∞—Ç—å –±–æ–ª—å—à–∏–µ LLM –¥–µ—à–µ–≤–ª–µ –∏ –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞—Ç—å —ç—Ç–æ —Å –∫–≤–∞–Ω—Ç–æ–≤–∞–Ω–∏–µ–º.</p><p id="2ab568fa-e39f-809b-9f72-d816df203687" class="">–ï—Å–ª–∏ —Ö–æ—á–µ—à—å, –º–æ–≥—É:</p><ul id="2ab568fa-e39f-8069-ba19-faec63699e1e" class="bulleted-list"><li style="list-style-type:disc">—Ä–∞—Å–ø–∏—Å–∞—Ç—å –º–æ–¥—É–ª—å 8 (LoRA/PEFT –¥–ª—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏, seq2seq –∏ Causal LM),</li></ul><ul id="2ab568fa-e39f-801a-be0c-d6eab66bc6b7" class="bulleted-list"><li style="list-style-type:disc">–∏–ª–∏ –ø–æ–º–æ—á—å —Å–æ–±—Ä–∞—Ç—å <strong>–æ–±—â–∏–π syllabus –ø–æ –≤—Å–µ–º –º–æ–¥—É–ª—è–º 0‚Äì7</strong> –≤ –∫–æ–º–ø–∞–∫—Ç–Ω–æ–º –≤–∏–¥–µ –¥–ª—è –ª–µ–Ω–¥–∏–Ω–≥–∞/–ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏ –∫—É—Ä—Å–∞.</li></ul></div></article><span class="sans" style="font-size:14px;padding-top:2em"></span></body></html>